import{af as ae,ag as te,ah as re,ai as ne,aj as le,ak as ie}from"./vendor-@element-plus-Cf--I8Lq.js";import{E as A}from"./vendor-element-plus-Bt6C2HhV.js";import{d as se,b as r,e as s,f as ce,m as ue,U as ve,c as x,R as E,a as g,u as h,E as $,Q as de,a4 as me,M as C,I,D as U,al as q,o as b}from"./vendor-@vue-Bz_wJ882.js";import{u as H}from"./vendor-vue-i18n-DztdJ-Qd.js";import{_ as pe}from"./index-D1Rhb41C.js";const _e={class:"voice"},fe={class:"voice__controls"},ge={class:"voice__controls_left"},he={key:0,class:"voice__membrane"},be={class:"voice__waves"},we={class:"voice__controls_right"},ye=se({__name:"VoicePlayer",props:{externalText:{}},emits:["toggleHelp","send"],setup(j,{emit:G}){const{locale:L}=H(),{t}=H(),Q=j,a={micDenied:r(()=>t("voice.microphoneDenied")),micNotFound:r(()=>t("voice.microphoneNotFound")),browserNoMic:r(()=>t("voice.browserNoMicrophone")),micError:r(()=>t("voice.microphoneError")),browserNoMedia:r(()=>t("voice.browserNoMedia")),allowMic:r(()=>t("voice.allowMicrophone")),micConnected:r(()=>t("voice.microphoneConnected")),browserNoSpeech:r(()=>t("voice.browserNoSpeech")),speechNotSupported:r(()=>t("voice.speechNotSupported")),recognitionInterrupted:r(()=>t("voice.recognitionInterrupted")),speechNotDetected:r(()=>t("voice.speechNotDetected")),recordingStarted:r(()=>t("voice.recordingStarted")),recordingStopped:r(()=>t("voice.recordingStopped")),startRecordError:r(()=>t("voice.startRecordingError")),stopRecordError:r(()=>t("voice.stopRecordingError")),networkIssues:r(()=>t("voice.networkIssues")),error:r(()=>t("voice.error")),textCleared:r(()=>t("voice.textCleared")),messagePlaceholder:r(()=>t("voice.messagePlaceholder"))},p=s(""),v=s(!1),F=s(!1),d=s(!1),u=s(!1),V=s(!1),l=s(null),k=s(""),f=s(null),_=s(null),S=s(null),w=s(0),R=s(!1),N=s(null);ce(()=>Q.externalText,e=>{e!=null&&(p.value=e,k.value=e)},{immediate:!0});const J=async e=>{try{N.value=e,f.value=new AudioContext,_.value=f.value.createAnalyser();const o=f.value.createMediaStreamSource(e);_.value.fftSize=256,_.value.smoothingTimeConstant=.8,o.connect(_.value),K()}catch(o){console.error("Error initializing audio analyzer:",o)}},K=()=>{R.value=!0;const e=()=>{if(!_.value||!R.value)return;const o=new Uint8Array(_.value.frequencyBinCount);_.value.getByteFrequencyData(o);let m=0;for(let c=0;c<o.length;c++)m+=o[c];const i=m/o.length;w.value=Math.min(i/100,1),S.value=requestAnimationFrame(e)};e()},D=()=>{R.value=!1,w.value=0,S.value&&(cancelAnimationFrame(S.value),S.value=null),N.value&&(N.value.getTracks().forEach(e=>e.stop()),N.value=null),f.value&&(f.value.close(),f.value=null),_.value=null},O=()=>{const e=window.SpeechRecognition||window.webkitSpeechRecognition;return d.value=!!e,!!e},n=e=>{A.error(e)},y=e=>{A.info(e)},W=e=>{A.success(e)},z=async()=>{var e;if(!((e=navigator.mediaDevices)!=null&&e.getUserMedia))return n(a.browserNoMedia.value),!1;V.value=!0;try{const o=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1});return await J(o),u.value=!1,P(),W(a.micConnected.value),!0}catch(o){return u.value=!0,o instanceof Error?o.name==="NotAllowedError"?n(a.micDenied.value):o.name==="NotFoundError"?n(a.micNotFound.value):o.name==="NotSupportedError"?n(a.browserNoMic.value):n(a.micError.value):n(a.micError.value),!1}finally{V.value=!1}},P=()=>{if(!O()){n(a.browserNoSpeech.value);return}const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){n(a.speechNotSupported.value);return}l.value=new e,l.value.continuous=!0,l.value.interimResults=!0,l.value.lang=L.value,l.value.onstart=()=>{v.value=!0,y(a.recordingStarted.value)},l.value.onresult=o=>{let m="";for(let i=o.resultIndex;i<o.results.length;i++){const c=o.results[i],T=c[0].transcript;c.isFinal?k.value+=T+" ":m+=T}p.value=k.value+m},l.value.onerror=o=>{switch(o.error){case"not-allowed":case"service-not-allowed":u.value=!0,n(a.micDenied.value);break;case"audio-capture":n(a.micNotFound.value);break;case"aborted":n(a.recognitionInterrupted.value);break;case"network":n(a.networkIssues.value);break;case"no-speech":y(a.speechNotDetected.value);break;default:n(`${a.error.value}: ${o.error}`)}M()},l.value.onend=()=>{v.value&&!F.value&&l.value?setTimeout(()=>{if(v.value&&l.value)try{l.value.start()}catch{M()}},100):(v.value=!1,y(a.recordingStopped.value))}},B=async()=>{d.value&&(u.value&&!await z()||(v.value?M():X()))},X=()=>{if(l.value)try{l.value.start(),y(a.recordingStarted.value)}catch(e){e instanceof Error&&(e.message.includes("permission")||e.name==="NotAllowedError")?(u.value=!0,D(),n(a.allowMic.value)):n(a.startRecordError.value)}},M=()=>{if(l.value)try{l.value.stop(),v.value=!1,F.value=!1,D()}catch{n(a.stopRecordError.value)}},Y=()=>{p.value="",k.value="",y(a.textCleared.value)},Z=async()=>{var e;try{if(!((e=navigator.mediaDevices)!=null&&e.enumerateDevices)){u.value=!0;return}const m=(await navigator.mediaDevices.enumerateDevices()).some(i=>i.kind==="audioinput"&&i.label!=="");u.value=!m}catch{u.value=!0}};ue(async()=>{await Z(),P()}),ve(()=>{D()});const ee=G,oe=()=>{ee("toggleHelp")};return(e,o)=>{const m=q("el-input"),i=q("el-button");return b(),x("div",_e,[E(m,{modelValue:p.value,"onUpdate:modelValue":o[0]||(o[0]=c=>p.value=c),type:"textarea",placeholder:a.messagePlaceholder.value,rows:6,resize:"none",class:"voice__textarea"},null,8,["modelValue","placeholder"]),g("div",fe,[g("div",ge,[E(i,{type:"success",onClick:o[1]||(o[1]=c=>e.$emit("send",p.value)),class:"voice__btn voice__btn_help",disabled:!p.value,icon:h(ae),circle:""},null,8,["disabled","icon"]),E(i,{type:"primary",onClick:oe,class:"voice__btn voice__btn_send",icon:h(te),circle:""},null,8,["icon"])]),v.value&&!u.value?(b(),x("div",he,[g("div",{class:"voice__visualizer",style:$({transform:`scale(${.8+w.value*.4})`,opacity:.7+w.value*.3})},[g("div",be,[(b(),x(de,null,me(3,c=>g("div",{key:c,class:"voice__wave",style:$({animationDelay:`${c*.2}s`,transform:`scale(${1+w.value*c*.3})`})},null,4)),64))])],4)])):C("",!0),g("div",we,[u.value&&d.value?(b(),I(i,{key:0,type:"warning",onClick:z,class:"voice__btn voice__btn_permission",icon:h(re),circle:""},null,8,["icon"])):C("",!0),!u.value&&d.value&&v.value?(b(),I(i,{key:1,type:"primary",onClick:B,class:U(["voice__btn",{voice__btn_recording:v.value,voice__btn_disabled:!d.value}]),disabled:!d.value,icon:h(ne),circle:""},null,8,["class","disabled","icon"])):C("",!0),!u.value&&d.value?(b(),I(i,{key:2,type:"danger",onClick:B,class:U(["voice__btn",{voice__btn_recording:v.value,voice__btn_disabled:!d.value}]),disabled:!d.value,icon:h(le),circle:""},null,8,["class","disabled","icon"])):C("",!0),E(i,{type:"danger",onClick:Y,class:"voice__btn voice__btn_clear",disabled:!p.value,icon:h(ie),circle:""},null,8,["disabled","icon"])])])])}}}),Re=pe(ye,[["__scopeId","data-v-360f4995"]]);export{Re as V};
